from flask import Flask, render_template, request
# í™”ë©´ì´ë™, ì„¸ì…˜ ì²˜ë¦¬ ë“±ì„ ìœ„í•œ ëª¨ë“ˆ ì„í¬íŠ¸
from flask import redirect, session, url_for
# ë¬¸ìì—´ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•œ ì¸ì½”ë”© ì²˜ë¦¬ë¥¼ ìœ„í•œ ëª¨ë“ˆ ì„í¬íŠ¸
from markupsafe import escape

app = Flask(__name__)

# session ì‚¬ìš©ì‹œ í•„ìˆ˜ì‚¬í•­ì¸ ì‹œí¬ë¦¿í‚¤
app.secret_key = 'A02as129wjDNGd/.sd12RT'

# ì˜ˆì‹œ ì‚¬ìš©ì (ì‹¤ì œ DB ì—°ê²° ëŒ€ì‹  í•˜ë“œì½”ë”©)
users = {
    'admin': '1234',
    'user' : '9876'
}


@app.route('/') 
def root(): 
  return 'Hello Flask Apps'

'''
session
  - ì‚¬ìš©ì ì •ë³´ ìœ ì§€ (ë¡œê·¸ì¸ ìƒíƒœ ë“±)
  - Flaskì˜ sessionì€ ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ìƒíƒœë‚˜ ì •ë³´ë¥¼ ë¸Œë¼ìš°ì €ì— ì €ì¥í•˜ëŠ” ë°©ì‹
    â†’ ì„œë²„ê°€ ì‚¬ìš©ìë¥¼ ê¸°ì–µí•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

ğŸ”¹ íŠ¹ì§•:
  - ë‚´ë¶€ì ìœ¼ë¡œëŠ” ì¿ í‚¤ë¥¼ ì‚¬ìš©
  - ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë¨ (ë³´ì•ˆ ê±±ì • ì¤„ì–´ë“¦)
  - session['username'] ì´ëŸ° ì‹ìœ¼ë¡œ ê°’ì„ ì €ì¥í•˜ê±°ë‚˜ ì½ìŒ
'''
'''
redirect() : ë‹¤ë¥¸ URLë¡œ ì´ë™ì‹œí‚¤ê¸°
  ex. return redirect('/login')  # /loginìœ¼ë¡œ ì´ë™
  
url_for() : URL ê²½ë¡œë¥¼ í•¨ìˆ˜ ì´ë¦„ìœ¼ë¡œ ìƒì„±
  ex. url_for('login')  # ê²°ê³¼: '/login'
  - í•˜ë“œì½”ë”©ì„ í”¼í•˜ê³ , ì½”ë“œ ë³€ê²½ì—ë„ ìë™ ë°˜ì˜ë˜ê¸° ë•Œë¬¸ì— ì¶”ì²œë˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
  - ë³€ìˆ˜ë„ ì „ë‹¬ ê°€ëŠ¥:
'''
@app.route('/mypage') 
def mypage(): 
  # í˜ì´ì§€ë¡œ ì§„ì…ì‹œ ì„¸ì…˜ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸(ë¡œê·¸ì¸ ë˜ì—ˆëŠ”ì§€ í™•ì¸)
  if 'username' in session:
    '''
    escape()ì˜ ì—­í• : HTML íŠ¹ìˆ˜ë¬¸ìë¥¼ ë¬´í•´í•˜ê²Œ ë°”ê¿”ì¤Œ
    ì¦‰, <, >, ', " ê°™ì€ íŠ¹ìˆ˜ ë¬¸ìê°€ HTMLë¡œ í•´ì„ë˜ì§€ ì•Šë„ë¡ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬í•´ì£¼ëŠ” í•¨ìˆ˜
    => usernameì— <b>ì² ìˆ˜</b> ê°™ì€ ê°’ì„ ë„£ì–´ë„, êµµê²Œ í‘œì‹œë˜ì§€ ì•Šê³  ê¸€ì ê·¸ëŒ€ë¡œ ë³´ì„
      ì•ˆì „í•œ ì›¹ í˜ì´ì§€ë¥¼ ë§Œë“¤ê¸° ìœ„í•œ ë³´ì•ˆ ìˆ˜ë‹¨ì…ë‹ˆë‹¤.
    '''
    # ë¡œê·¸ì¸ëœ ìƒíƒœë¼ë©´ welcomeí˜ì´ì§€ë¥¼ ë Œë”ë§.
    # í…œí”Œë¦¿ìœ¼ë¡œ íšŒì›ì˜ ì•„ì´ë””ë¥¼ ì „ë‹¬
    '''
    ğŸ” escape(session['username'])ëŠ”
    HTMLë¡œ í•´ì„ë˜ì§€ ì•Šë„ë¡ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•œ ê°’ì„
    â†’ usernameì´ë¼ëŠ” ë³€ìˆ˜ì— ì €ì¥í•´ì„œ í…œí”Œë¦¿ì— ì „ë‹¬í•˜ëŠ” ê²ƒ
    
    session['username']ì—ëŠ” ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ì´ ë“¤ì–´ ìˆì„ ìˆ˜ ìˆì–´ìš”.
    ì˜ˆì‹œ: "<script>alert(1)</script>" => escape í•˜ë©´ ê¸€ìë¡œ ë°”ê¿”ì„œ ë³´ì—¬ì¤€ë‹¤.
    '''
    return render_template('welcome.html',
              username=escape(session['username']))
  # ë¡œê·¸ì¸ì´ ì•ˆëœ ìƒíƒœë¼ë©´ loginí˜ì´ì§€ë¡œ ì´ë™.
  # url_for() í•¨ìˆ˜ì˜ ì¸ìˆ˜ëŠ” ì‹¤í–‰í•  í•¨ìˆ˜ëª…ì„ ê¸°ìˆ 
  return redirect(url_for('login'))


# ë¡œê·¸ì¸ í˜ì´ì§€
@app.route('/login', methods=['GET', 'POST']) 
def login():
  # í¼ê°’ì„ ì…ë ¥í›„ submit(ì „ì†¡)í–ˆì„ë•Œ
  if request.method == 'POST':
    # POST ë°©ì‹ì˜ ì „ì†¡ì´ë¯€ë¡œ formì„ ì´ìš©í•´ì„œ ê°’ ë°›ìŒ
    input_id = request.form['username'] 
    input_pw = request.form['password']
    # ì‚¬ìš©ì ì¸ì¦. ì…ë ¥í•œ ì •ë³´ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸.
    if input_id in users \
      and users[input_id] == input_pw:
      # ì •ë³´ê°€ ì¼ì¹˜í•˜ë©´ ì„¸ì…˜ì— ì‚¬ìš©ìì˜ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì„œ ìƒì„±
      session['username'] = input_id
      # ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™
      return redirect(url_for('mypage'))
    else:
      # ì‚¬ìš©ì ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ëŠ” ë‹¤ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
      # ì´ë•Œ errorë¼ëŠ” ë³€ìˆ˜ì— ë©”ì„¸ì§€ë¥¼ ì „ë‹¬í•œë‹¤.
      return render_template('login.html',
                      error='ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.')
  # ì²« ì§„ì…ì‹œì—ëŠ” ë©”ë‰´ í´ë¦­ì„ í†µí•´ ì´ë™í•˜ê²Œ ë˜ë¯€ë¡œ GETë°©ì‹ì˜ ìš”ì²­ì„
  # ë”°ë¼ì„œ ë¡œê·¸ì¸ í¼ì„ ë³´ì—¬ì¤€ë‹¤.
  return render_template('login.html')


# ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
@app.route('/logout') 
def logout(): 
  # ì„¸ì…˜ì— ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ì‚­ì œí•œë‹¤.
  session.pop('username', None)
  # ì‚­ì œê°€ ì™„ë£Œë˜ë©´ indexí™”ë©´ìœ¼ë¡œ ì´ë™í•œë‹¤.
  return redirect(url_for('root'))



if __name__ == '__main__':
  app.run(host='127.0.0.1', port=8080, debug=True)
