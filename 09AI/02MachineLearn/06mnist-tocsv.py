import struct
'''
struct ëª¨ë“ˆ
    ë°”ì´ë„ˆë¦¬ ë°ì´í„° ì½ê¸°ìš© ë„êµ¬
    unpack()ì„ ì´ìš©í•´ ì´ì§„ ë°ì´í„°ë¥¼ ì •ìˆ˜ ë“±ìœ¼ë¡œ ë³€í™˜
'''

# ë‹¤ìš´ë¡œë“œ í•œ ë°”ì´ë„ˆë¦¬ íŒŒì¼ì„ csvíŒŒì¼ë¡œ ë³€í™˜í•˜ê¸° ìœ„í•œ í•¨ìˆ˜
'''
name: íŒŒì¼ ì´ë¦„ ì•ë¶€ë¶„ ("train" ë˜ëŠ” "t10k").
maxdata: ëª‡ ê°œì˜ ë°ì´í„°ë§Œ ë³€í™˜í•  ê²ƒì¸ì§€. (ì „ì²´ ë‹¤ ì•ˆ í•˜ê³  ì¼ë¶€ë§Œ)
'''
def to_csv(name, maxdata):
    # ë ˆì´ë¸” íŒŒì¼ê³¼ ì´ë¯¸ì§€ íŒŒì¼ ì—´ê¸°
    # ë ˆì´ë¸” íŒŒì¼ : ìˆ«ìì˜ ì‹¤ì œê°’ì„ ì €ì¥í•  íŒŒì¼
    lbl_f = open("./resMnist/" + name + "-labels-idx1-ubyte", "rb") # "rb"(ë°”ì´ë„ˆë¦¬ ì½ê¸°)
    # ì´ë¯¸ì§€ íŒŒì¼ : ì†ê¸€ì”¨ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì €ì¥í•œ íŒŒì¼
    img_f = open("./resMnist/" + name + "-images-idx3-ubyte", "rb")
    # ë³€í™˜ëœ ë°ì´í„°ë¥¼ ì €ì¥í•  csv íŒŒì¼ ê²½ë¡œ(ì“°ê¸° ëª¨ë“œ)
    csv_f = open("./resMnist/" + name + ".csv", "w", encoding="utf-8")
    print('lbl_f', lbl_f)
    print('img_f', img_f)
    '''
    ë ˆì´ë¸” íŒŒì¼: ìˆ«ì ì •ë‹µ (ì˜ˆ: ì´ ì´ë¯¸ì§€ëŠ” â€˜7â€™ì´ë‹¤)
    ì´ë¯¸ì§€ íŒŒì¼: ì†ê¸€ì”¨ ì´ë¯¸ì§€ í”½ì…€ê°’ (28Ã—28)
    CSV íŒŒì¼: ë³€í™˜í•´ì„œ ì €ì¥í•  í…ìŠ¤íŠ¸ íŒŒì¼
    '''

    # í—¤ë” ì •ë³´ ì½ê¸°
    ''' struct ëª¨ë“ˆì„ ì‚¬ìš©í•˜ì—¬ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ ì½ê³  ì •ìˆ˜ë¡œ ë³€í™˜í•œë‹¤.
    >II ëŠ” ë¹…ì—”ë””ì•ˆ ë°©ì‹ìœ¼ë¡œ 4ë°”ì´íŠ¸ ì •ìˆ˜ 2ê°œë¥¼ ì½ê² ë‹¤ëŠ” ì˜ë¯¸ë¡œ ì‚¬ìš©ëœë‹¤. '''
    '''
    struct.unpack(format, bytes)
        ë°”ì´íŠ¸(ì´ì§„ ë°ì´í„°)ë¥¼ ìš°ë¦¬ê°€ ì•„ëŠ” ìˆ«ìë‚˜ ë¬¸ìì—´ ë“±ìœ¼ë¡œ ë³€í™˜í•´ì£¼ëŠ” í•¨ìˆ˜
        -> ì‚¬ëŒì´ ì½ì„ ìˆ˜ ìˆëŠ” ì •ìˆ˜ë‚˜ ì‹¤ìˆ˜ë¡œ ë°”ê¾¸ëŠ” ì‘ì—…
        
    ğŸ“Œ ìì£¼ ì“°ëŠ” í¬ë§· ì½”ë“œ
    ì½”ë“œ	ì˜ë¯¸	ë°”ì´íŠ¸ ìˆ˜
    B	unsigned char (0~255)	1ë°”ì´íŠ¸
    H	unsigned short	2ë°”ì´íŠ¸
    I	unsigned int	4ë°”ì´íŠ¸
    f	float	4ë°”ì´íŠ¸
    d	double	8ë°”ì´íŠ¸
    >	big-endian (ë„¤íŠ¸ì›Œí¬ ë°©ì‹)	
    <	little-endian (x86 CPU ê¸°ë³¸)
    '''
    # ë°”ì´ë„ˆë¦¬ íŒŒì¼ì—ì„œ 8ë°”ì´íŠ¸ë¥¼ ì½ì–´ì„œ,
    # ê·¸ê±¸ ë‘ ê°œì˜ 4ë°”ì´íŠ¸ ì •ìˆ˜(unsigned int)ë¡œ í•´ì„í•˜ëŠ” ì½”ë“œ
    mag, lbl_count = struct.unpack(">II", lbl_f.read(8))
    '''
    ì»´í“¨í„°ëŠ” 0~255ê¹Œì§€ë¥¼ 1ë°”ì´íŠ¸(8ë¹„íŠ¸)**ë¡œ ì²˜ë¦¬
    1ë°”ì´íŠ¸ = 8ë¹„íŠ¸
    2â¸ = 256ê°€ì§€ ê²½ìš°ì˜ ìˆ˜
    ê·¸ë˜ì„œ 0 ~ 255ê¹Œì§€ í‘œí˜„ ê°€ëŠ¥
    '''
    # ë ˆì´ë¸”ê³¼ ì´ë¯¸ì§€ íŒŒì¼ì—ì„œ ë§¤ì§ë„˜ë²„ì™€ ì´ì´í…œ ê°œìˆ˜ ì½ê¸°
    # ë°˜í™˜ëœ íŠœí”Œì˜ ì²« ê°’ì€ ë§¤ì§ ë„˜ë²„, ë‘ ë²ˆì§¸ ê°’ì€ ë ˆì´ë¸” ê°œìˆ˜
    mag, img_count = struct.unpack(">II", img_f.read(8))
    # ì´ë¯¸ì§€ì˜ í–‰ê³¼ ì—´ í¬ê¸° ì½ê¸°
    rows, cols = struct.unpack(">II", img_f.read(8))
    # ì´ë¯¸ì§€ì˜ í”½ì…€ ê°œìˆ˜ ê³„ì‚°(28*28)
    pixels = rows * cols

    # ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì½ê³  CSVë¡œ ì €ì¥
    res = []
    for idx in range(lbl_count):
        # ìµœëŒ€ ë°ì´í„° ê°œìˆ˜ë¥¼ ì´ˆê³¼í•˜ë©´ ë°˜ë³µë¬¸ íƒˆì¶œ
        if idx > maxdata:
            break

        # ë ˆì´ë¸”(0~9)ì„ 1ë°”ì´íŠ¸ì”© ì½ì–´ì„œ ì •ìˆ˜ë¡œ ë³€í™˜
        label = struct.unpack("B", lbl_f.read(1))[0]
        # ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ í”½ì…€ ë‹¨ìœ„ë¡œ ì½ê¸°
        bdata = img_f.read(pixels)
        # ê° í”½ì…€ê°’ì„ ë¬¸ìì—´ë¡œ ë³€í™˜ í›„ ë¦¬ìŠ¤íŠ¸ì— ì €ì¥
        sdata = list(map(lambda n: str(n), bdata))
        # csv íŒŒì¼ì— ë°ì´í„° ì €ì¥
        csv_f.write(str(label)+",") # ì²«ë²ˆì§¸ ì»¬ëŸ¼ì— ë ˆì´ë¸” ì €ì¥
        csv_f.write(",".join(sdata)+"\r\n") # í”½ì…€ ë°ì´í„° ì €ì¥ í›„ ì¤„ë°”ê¿ˆ

        # ì˜ ì €ì¥ëëŠ”ì§€ ì¼ë¶€ ì´ë¯¸ì§€ íŒŒì¼ì„ PGM í¬ë§·ìœ¼ë¡œ ì €ì¥í•´ì„œ í™•ì¸
        if idx < 10: # ì²˜ìŒ 10ê°œë§Œ ì €ì¥
            s = "P2 28 28 255\n" # PGM í—¤ë”(ASCII í˜•ì‹ì˜ ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ì´ë¯¸ì§€)
            s += " ".join(sdata) # í”½ì…€ ë°ì´í„°ë¥¼ ê³µë°±ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì¶”ê°€
            # ì €ì¥ë  íŒŒì¼ì˜ ì´ë¦„ê³¼ ê²½ë¡œë¥¼ ì§€ì •
            iname = "./resMnist/{0}-{1}-{2}.pgm".format(name, idx, label)
            '''
            íŒŒì¼ëª…ì€ ./resMnist/{ì´ë¦„}-{ë²ˆí˜¸}-{ë ˆì´ë¸”}.pgm ìœ¼ë¡œ ë§Œë“¤ì–´ ì €ì¥
            PGM íŒŒì¼ì€ ì´ë¯¸ì§€ ë·°ì–´ì—ì„œ ì—´ì–´ë³¼ ìˆ˜ ìˆëŠ” ê°„ë‹¨í•œ í‘ë°± ì´ë¯¸ì§€ íŒŒì¼
            '''
            with open(iname, "w", encoding="utf-8") as f:
                f.write(s)

    # ìì›í•´ì œ
    csv_f.close()
    lbl_f.close()
    img_f.close()

# # ë°”ì´ë„ˆë¦¬ íŒŒì¼ì„ ì½ì–´ csvíŒŒì¼ë¡œ ë³€í™˜í•˜ì—¬ ì‹¤í–‰
# to_csv("train", 1000) # í•™ìŠµë°ì´í„° 1000ê°œ
# to_csv("t10k", 500) # í…ŒìŠ¤íŠ¸ë°ì´í„° 500ê°œ

# MNIST ì „ì²´ ë°ì´í„°ë¥¼ CSVë¡œ ë³€í™˜
to_csv("train", 70000)
to_csv("t10k", 20000)